<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>FamilyHub v36.4 (Full Admin Access)</title>
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
    <link href="https://fonts.googleapis.com/css2?family=Plus+Jakarta+Sans:wght@400;600;800;900&display=swap" rel="stylesheet">
    <style>
        :root { --bg: #030712; --card: #111827; --accent: #38bdf8; --text: #f3f4f6; --red: #f87171; --green: #4ade80; --yellow: #fbbf24; }
        body.theme-blue { --accent: #38bdf8; --bg: #030712; }
        * { box-sizing: border-box; -webkit-tap-highlight-color: transparent; }
        body { font-family: 'Plus Jakarta Sans', sans-serif; margin: 0; background: var(--bg); color: var(--text); transition: 0.3s; }
        
        #loader { position: fixed; inset: 0; background: var(--bg); z-index: 9999; display: flex; align-items: center; justify-content: center; }
        .spin { width: 40px; height: 40px; border: 4px solid rgba(255,255,255,0.1); border-top-color: var(--accent); border-radius: 50%; animation: s 1s linear infinite; }
        @keyframes s { to { transform: rotate(360deg); } }

        .container { max-width: 500px; margin: 0 auto; padding: 75px 20px 20px; }
        .card { background: var(--card); border-radius: 24px; padding: 20px; border: 1px solid rgba(255,255,255,0.05); margin-bottom: 15px; }
        input, select { width: 100%; background: #000; border: 1px solid #1f2937; color: #fff; padding: 12px; border-radius: 14px; margin-bottom: 8px; font-weight: 600; }
        .btn { background: var(--accent); color: #000; border: none; padding: 16px; border-radius: 18px; width: 100%; cursor: pointer; font-weight: 900; }

        .top-bar { position: fixed; top: 0; left: 0; right: 0; background: rgba(0,0,0,0.8); backdrop-filter: blur(20px); z-index: 1000; padding: 10px 20px; border-bottom: 1px solid rgba(255,255,255,0.05); display: flex; justify-content: space-between; align-items: center; height: 65px; }
        
        /* КАНБАН ГРАФИКИ */
        .kanban-bar { height: 8px; background: rgba(255,255,255,0.1); border-radius: 4px; overflow: hidden; margin: 4px 0 12px; }
        .kanban-fill { height: 100%; background: var(--accent); transition: 0.8s cubic-bezier(0.4, 0, 0.2, 1); width: 0%; }
        
        .history-item { padding: 10px 0; border-bottom: 1px solid rgba(255,255,255,0.05); font-size: 14px; }
        .chat-box { height: 250px; overflow-y: auto; display: flex; flex-direction: column; gap: 8px; margin-bottom: 10px; }
        .msg { background: rgba(255,255,255,0.05); padding: 10px 15px; border-radius: 15px; width: fit-content; max-width: 85%; }
        .msg.me { align-self: flex-end; background: var(--accent); color: #000; }
        
        .day { aspect-ratio: 1; display: flex; align-items: center; justify-content: center; background: #1e293b; border-radius: 10px; font-weight: 800; cursor: pointer; font-size: 12px; }
        .day.active { background: var(--accent); color: #000; }
        .cal-grid { display: grid; grid-template-columns: repeat(7, 1fr); gap: 5px; }
    </style>
</head>
<body class="theme-blue">

<div id="loader"><div class="spin"></div></div>

<div id="auth-screen" style="display:none; padding: 100px 20px; text-align: center;">
    <h1 style="font-size: 40px; color: var(--accent);">Family Hub</h1>
    <input type="email" id="email" placeholder="Email">
    <input type="password" id="pass" placeholder="Пароль">
    <button class="btn" onclick="handleAuth()">ВОЙТИ В ОБЩУЮ СЕТЬ</button>
</div>

<div id="app-screen" style="display:none">
    <div class="top-bar">
        <div style="font-weight:900;">
            <span style="color:var(--green)">+ <span id="v-inc">0</span></span>
            <span style="color:var(--red); margin-left:15px">- <span id="v-exp">0</span></span>
        </div>
        <div style="font-weight: 800; font-size: 12px; color: var(--accent)">РЕЖИМ: ОБЩИЙ ДОСТУП</div>
    </div>

    <div class="container">
        <div class="card">
            <h3 style="font-size:11px; opacity:0.5; margin-top:0">ОБЩИЕ ФИНАНСЫ</h3>
            <div style="display:flex; gap:5px">
                <input type="number" id="f-sum" placeholder="Сумма">
                <select id="f-type" style="width: 120px"><option value="exp">-</option><option value="inc">+</option></select>
            </div>
            <input type="text" id="f-com" placeholder="Комментарий">
            <button class="btn" onclick="addFinance()">ДОБАВИТЬ ДЛЯ ВСЕХ</button>
            <div id="finance-stats" style="margin-top:20px"></div>
            <hr style="opacity:0.05; margin: 15px 0">
            <div id="finance-history" style="max-height: 200px; overflow-y: auto;"></div>
        </div>

        <div class="card">
            <h3 style="font-size:11px; opacity:0.5; margin-top:0">ОБЩИЙ ЧАТ</h3>
            <div id="chat-list" class="chat-box"></div>
            <div style="display:flex; gap:5px">
                <input type="text" id="chat-in" placeholder="Сообщение..." style="margin:0">
                <button class="btn" style="width:60px" onclick="sendMsg()">></button>
            </div>
        </div>

        <div class="card">
            <h3 style="font-size:11px; opacity:0.5; margin-top:0">ОБЩИЙ КАЛЕНДАРЬ</h3>
            <div class="cal-grid" id="cal-days"></div>
            <div id="day-tasks" style="margin: 15px 0; font-size: 14px;"></div>
            <div style="display:flex; gap:5px">
                <input type="text" id="t-in" placeholder="Добавить задачу..." style="margin:0">
                <button class="btn" style="width:60px" onclick="addTask()">+</button>
            </div>
        </div>
        
        <button class="btn" onclick="forceLogout()" style="background:none; color:var(--red); border:1px solid #333; margin-bottom:50px">ВЫЙТИ</button>
    </div>
</div>

<script>
    const SUPABASE_URL = "https://qmhlniyvueaatnxknfff.supabase.co"; 
    const SUPABASE_KEY = "sb_publishable_sDpVaDfmXJ57QaQTeoJ-dQ_YuDonR5J";
    const sb = supabase.createClient(SUPABASE_URL, SUPABASE_KEY);

    // КЛЮЧЕВОЙ МОМЕНТ: Используем ОДИН ID для всей базы данных
    const GLOBAL_ID = "shared_family_data_v36";
    let state = { inc: 0, exp: 0, messages: [], tasks: [], fin_logs: [] };
    let me = { name: "Пользователь" };
    let selDay = new Date().getDate();

    async function loadGlobalData() {
        const { data } = await sb.from('family_v10_data').select('payload').eq('id', GLOBAL_ID).maybeSingle();
        if (data) state = data.payload;
        render();
    }

    async function sync() {
        await sb.from('family_v10_data').upsert({ id: GLOBAL_ID, payload: state });
    }

    async function handleAuth() {
        const e = document.getElementById('email').value, p = document.getElementById('pass').value;
        const { data, error } = await sb.auth.signInWithPassword({ email: e, password: p });
        if (!error) {
            const { data: profile } = await sb.from('family_v10_profiles').select('name').eq('id', data.user.id).single();
            if (profile) me.name = profile.name;
            startApp();
        } else alert("Ошибка входа");
    }

    function render() {
        document.getElementById('v-inc').innerText = (state.inc || 0).toLocaleString();
        document.getElementById('v-exp').innerText = (state.exp || 0).toLocaleString();

        // 1. Канбан статистика (Траты по людям)
        const stats = {};
        (state.fin_logs || []).forEach(l => { if(l.val < 0) stats[l.u] = (stats[l.u] || 0) + Math.abs(l.val); });
        const max = Math.max(...Object.values(stats), 1);
        document.getElementById('finance-stats').innerHTML = Object.entries(stats).map(([n, v]) => `
            <div style="margin-bottom:10px">
                <div style="display:flex; justify-content:space-between; font-size:11px; font-weight:800"><span>${n}</span><span>${v} ₽</span></div>
                <div class="kanban-bar"><div class="kanban-fill" style="width:${(v/max)*100}%"></div></div>
            </div>`).join('');

        // 2. История
        document.getElementById('finance-history').innerHTML = (state.fin_logs || []).slice().reverse().map(l => `
            <div class="history-item">
                <div style="display:flex; justify-content:space-between"><b>${l.u}</b> <span style="color:${l.val>0?'var(--green)':'var(--red)'}">${l.val} ₽</span></div>
                <div style="font-size:11px; opacity:0.5">${l.com}</div>
            </div>`).join('');

        // 3. Чат
        document.getElementById('chat-list').innerHTML = (state.messages || []).slice(-30).map(m => `
            <div class="msg ${m.u === me.name ? 'me' : ''}">
                <div style="font-size:10px; font-weight:900; margin-bottom:2px">${m.u}</div>
                <div>${m.t}</div>
            </div>`).join('');
        document.getElementById('chat-list').scrollTop = 9999;

        // 4. Календарь
        const daysInMonth = new Date(new Date().getFullYear(), new Date().getMonth() + 1, 0).getDate();
        let calHtml = '';
        for(let d=1; d<=daysInMonth; d++) {
            const has = (state.tasks || []).some(t => t.day == d);
            calHtml += `<div class="day ${selDay==d?'active':''}" onclick="selDay=${d};render()">${d}${has?'<div style="width:4px;height:4px;background:#fff;border-radius:50%;margin-top:2px"></div>':''}</div>`;
        }
        document.getElementById('cal-days').innerHTML = calHtml;
        document.getElementById('day-tasks').innerHTML = (state.tasks || []).filter(t => t.day == selDay).map(t => `<div>• ${t.t}</div>`).join('') || 'Нет задач';
    }

    async function addFinance() {
        const s = parseFloat(document.getElementById('f-sum').value), t = document.getElementById('f-type').value, c = document.getElementById('f-com').value;
        if(!s) return;
        const val = t === 'exp' ? -s : s;
        if(t === 'inc') state.inc += s; else state.exp += s;
        state.fin_logs.push({ u: me.name, val, com: c || 'Без описания', date: new Date().toISOString() });
        document.getElementById('f-sum').value = ''; document.getElementById('f-com').value = '';
        await sync(); render();
    }

    async function sendMsg() {
        const i = document.getElementById('chat-in'); if(!i.value) return;
        state.messages.push({ u: me.name, t: i.value });
        i.value = ''; await sync(); render();
    }

    async function addTask() {
        const i = document.getElementById('t-in'); if(!i.value) return;
        state.tasks.push({ day: selDay, t: i.value });
        i.value = ''; await sync(); render();
    }

    function startApp() {
        document.getElementById('loader').style.display = 'none';
        document.getElementById('auth-screen').style.display = 'none';
        document.getElementById('app-screen').style.display = 'block';
        loadGlobalData();
        // РЕАЛЬНОЕ ВРЕМЯ: слушаем изменения именно GLOBAL_ID
        sb.channel('global_sync').on('postgres_changes', { event: 'UPDATE', table: 'family_v10_data', filter: `id=eq.${GLOBAL_ID}` }, payload => {
            state = payload.new.payload;
            render();
        }).subscribe();
    }

    function forceLogout() { sb.auth.signOut(); location.reload(); }

    sb.auth.getSession().then(({data}) => { 
        if(data.session) {
            sb.from('family_v10_profiles').select('name').eq('id', data.session.user.id).single().then(({data:p}) => {
                if(p) me.name = p.name;
                startApp();
            });
        } else {
            document.getElementById('loader').style.display = 'none';
            document.getElementById('auth-screen').style.display = 'block';
        }
    });
</script>
</body>
</html>
